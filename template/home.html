<!DOCTYPE html>
<html lang="en">
{% include 'header.html' %}
    <script src="{{STATIC_URL}}js/jquery-1.11.0.js"></script>
    <script src="{{STATIC_URL}}js/utils.js"></script>
    <script src="{{STATIC_URL}}js/dat.gui.min.js"></script>
    <script src="{{STATIC_URL}}js/numeric-1.2.6.min.js"></script>
    <script src="{{STATIC_URL}}js/mosse.js"></script>
    <script src="{{STATIC_URL}}js/jsfeat-min.js"></script>
    <script src="{{STATIC_URL}}js/frontalface.js"></script>
    <script src="{{STATIC_URL}}js/jsfeat_detect.js"></script>
    <script src="{{STATIC_URL}}js/left_eye_filter.js"></script>
    <script src="{{STATIC_URL}}js/right_eye_filter.js"></script>
    <script src="{{STATIC_URL}}js/nose_filter.js"></script>
    <script src="{{STATIC_URL}}js/models/model_pca_20_svm.js"></script>
    <script src="{{STATIC_URL}}js/clm.js"></script>
    <script src="{{STATIC_URL}}js/svmfilter_webgl.js"></script>
    <script src="{{STATIC_URL}}js/svmfilter_fft.js"></script>
    <script src="{{STATIC_URL}}js/mossefilter.js"></script>
    
    <script src="{{STATIC_URL}}js/clmtrackr.js"></script>
    <script src="{{STATIC_URL}}js/models/model_pca_20_svm_emotionDetection.js"></script>
    <script src="{{STATIC_URL}}js/d3.min.js"></script>
    <script src="{{STATIC_URL}}js/emotion_classifier.js"></script>
    <script src="{{STATIC_URL}}js/emotionmodel.js"></script>
    
    <script src="{{STATIC_URL}}js/jquery.imgareaselect.pack.js"></script>
    <script src="{{STATIC_URL}}js/BlobBuilder.min.js"></script>
    <script src="{{STATIC_URL}}js/Filesaver.min.js"></script>
   
    <script>
        $(document).ready(function() {
            var imgUrl = '';
            var ec = new emotionClassifier();
            ec.init(emotionModel);
            var emotionData = ec.getBlank();    
            
            $("#post-btn").click(function(){
                var cp = ctrack.getCurrentParameters();
                var er = ec.predict(cp);
                var major = $('#angry').val();
                var majorname = "angry";
                $('#angry').val(er[0].value.toString());
                $('#sad').val(er[1].value.toString());
                $('#surprised').val(er[2].value.toString());
                $('#happy').val(er[3].value.toString());
                var majorindex=0;
                for(var i = 1;i < 4; i++) {
                    if(er[i].value > er[majorindex].value)
                        majorindex = i;
                }

                for(var i = 0;i < 4; i++) {
                    if(i != majorindex)
                        $('#' + er[i].emotion).addClass('hide');
                }

                var postMood = {
                    img: imgUrl,
                    text: $('#text').val(),
                    emotion: er[majorindex].emotion
                }
                $.post('/post/', postMood, function(ret) {
                    console.log(ret);
                })
            });

            var cc = document.getElementById('image').getContext('2d'); 
            $('#image').click(function(){
                $('#img').click();
            })

            var ctrack = new clm.tracker({stopOnConvergence : true});
            ctrack.init(pModel);
            
            var drawRequest;
            
            function animateClean() {
                ctrack.start(document.getElementById('image'));
                drawLoop();
            }

            function animate(box) {
                ctrack.start(document.getElementById('image'), box);
                drawLoop();
            }
            
            function drawLoop() {
                drawRequest = requestAnimFrame(drawLoop);
                overlayCC.clearRect(0, 0, 720, 576);
                if (ctrack.getCurrentPosition()) {
                    ctrack.draw(overlay);
                }
            }
            
            // detect if tracker fails to find a face
            document.addEventListener("clmtrackrNotFound", function(event) {
                ctrack.stop();
                console.log("也是有点识别不出来啊....换一张吧")
            }, false);
            
            // detect if tracker loses tracking of face
            // detect if tracker has converged
            document.addEventListener("clmtrackrConverged", function(event) {
                // stop drawloop
                cancelRequestAnimFrame(drawRequest);
            }, false);
            
            // update stats on iteration
            // document.addEventListener("clmtrackrIteration", function(event) {
            //     stats.update();
            // }, false);

            // manual selection of faces (with jquery imgareaselect plugin)
            function selectBox() {
                document.getElementById('convergence').innerHTML = "";
                ctrack.reset();
                $('#overlay').addClass('hide');
                $('#image').imgAreaSelect({
                    handles : true,
                    onSelectEnd : function(img, selection) {
                        // create box
                        var box = [selection.x1, selection.y1, selection.width, selection.height];
                        
                        // do fitting
                        animate(box);
                    },
                    autoHide : true
                });
            }

            // function to start showing images
            function loadImage() {
                if (fileList.indexOf(fileIndex) < 0) {
                    var reader = new FileReader();
                    reader.onload = (function(theFile) {
                        return function(e) {
                            // check if positions already exist in storage
                        
                            // Render thumbnail.
                            var canvas = document.getElementById('image')
                            var cc = canvas.getContext('2d');
                            var img = new Image();
                            img.onload = function() {
                                if (img.height > 500 || img.width > 550) {
                                    var rel = parseFloat(img.height)/img.width;
                                    var neww = 550 * rel;
                                    var newh = 500 * rel;
                                    if (img.height <= 500 && neww > 550) {
                                        neww = 550;
                                        // newh = newh * neww/rel;
                                    }
                                }
                                canvas.setAttribute('width', img.width);
                                canvas.setAttribute('height', img.height);
                                cc.drawImage(img,parseFloat(550-img.width)/2,
                                    parseFloat(500-img.height)/2,550, 500);
                            }
                             
                            // console.log(e.target.result)
                            imgUrl = e.target.result;
                            img.src = e.target.result;
                        };
                    })(fileList[fileIndex]);
                    reader.readAsDataURL(fileList[fileIndex]);
                    ctrack.reset();
                }

            }

            // set up file selector and variables to hold selections
            var fileList, fileIndex = 0;
            if (window.File && window.FileReader && window.FileList) {
                function handleFileSelect(evt) {
                    var files = evt.target.files;
                    fileList = [];
                    for (var i = 0;i < files.length;i++) {
                        if (!files[i].type.match('image.*')) {
                            continue;
                        }
                        fileList.push(files[i]);
                    }
                    if (files.length > 0) {
                        fileIndex = 0;
                    }
                    
                    loadImage();
                    ctrack.start(document.getElementById('image'));
                }
                document.getElementById('img').addEventListener('change', handleFileSelect, false);
            } else {
                // $('#img').addClass("hide");
                $('#loadimagetext').addClass("hide");
            }
    });
    </script>

<body>

<div class="jumbotron">
    <div class="container">
        <h1>心情轴</h1><p>留下你的脚印，回顾心路历程...</p>
    </div>
    {% include 'post.html' %}
</div>


    <div class="container-fluid">
        <div class="post col-lg-12">
            <div class="post-img col-lg-8">
                <img class="col-lg-12" src="{{STATIC_URL}}img/slide-1.jpg" alt="">
            </div>
            <div class="post-text col-lg-4 text-center">
                <h3>感觉hackathon要写不完了啊...</h3>
                <h3>
                    <small>October 13, 2013</small>
                </h3>
                <!-- <a href="#" class="btn btn-default btn-lg">Read More</a> -->
            </div>
            <hr>
        </div>
        
        <div class="post col-lg-12">
            <div class="post-img col-lg-8">
                <img class="col-lg-12" src="{{STATIC_URL}}img/slide-2.jpg" alt="">
            </div>
            <div class="post-text col-lg-4 text-center">
                <h3>感觉hackathon要写不完了啊...</h3>
                <h3>
                    <small>October 13, 2014</small>
                </h3>
            </div>
            <hr>
        </div>

        <div class="post col-lg-12">
            <div class="post-img col-lg-8">
                <img class="col-lg-12" src="{{STATIC_URL}}img/slide-3.jpg" alt="">
            </div>
            <div class="post-text col-lg-4 text-center">
                <h3>感觉hackathon要写不完了啊...</h3>
                <h3>
                    
                    <small>October 13, 2015</small>
                </h3>
            </div>
            <hr>
        </div>

        <div class="post col-lg-12">
            <div class="post-img col-lg-8">
                <img class="col-lg-12" src="{{STATIC_URL}}img/slide-4.jpg" alt="">
            </div>
            <div class="post-text col-lg-4 text-center">
                <h3>感觉hackathon要写不完了啊...</h3>
                <h3>
                    
                    <small>October 13, 2015</small>
                </h3>
            </div>
            <hr>
        </div>

        <div class="post col-lg-12">
            <div class="post-img col-lg-8">
                <img class="col-lg-12" src="{{STATIC_URL}}img/slide-4.jpg" alt="">
            </div>
            <div class="post-text col-lg-4 text-center">
                <h3>感觉hackathon要写不完了啊...</h3>
                <h3>
                    
                    <small>October 13, 2015</small>
                </h3>
            </div>
            <hr>
        </div>

        <div class="post col-lg-12">
            <div class="post-img col-lg-8">
                <img class="col-lg-12" src="{{STATIC_URL}}img/slide-5.jpg" alt="">
            </div>
            <div class="post-text col-lg-4 text-center">
                <h3>感觉hackathon要写不完了啊...</h3>
                <h3>
                    
                    <small>October 13, 2016</small>
                </h3>
            </div>
            <hr>
        </div>

        <div class="post col-lg-12">
            <div class="post-img col-lg-8">
                <img class="col-lg-12" src="{{STATIC_URL}}img/slide-6.jpg" alt="">
            </div>
            <div class="post-text col-lg-4 text-center">
                <h3>感觉hackathon要写不完了啊...</h3>
                <h3>
                    
                    <small>October 13, 2017</small>
                </h3>
            </div>
            <hr>
        </div>

        <div class="post col-lg-12">
            <div class="post-img col-lg-8">
                <img class="col-lg-12" src="{{STATIC_URL}}img/slide-7.jpg" alt="">
            </div>
            <div class="post-text col-lg-4 text-center">
                <h3>感觉hackathon要写不完了啊...</h3>
                <h3>
                    
                    <small>October 13, 2018</small>
                </h3>
            </div>
            <hr>
        </div>


        <div class="col-lg-12 text-center">
            <ul class="pager">
                <li class="previous"><a href="#">&larr; Older</a>
                </li>
                <li class="next"><a href="#">Newer &rarr;</a>
                </li>
            </ul>
        </div>

    </div>

    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <p>Copyright &copy; Your Website 2014</p>
                </div>
            </div>
        </div>
    </footer>

{% include 'footer.html' %}


</body>

</html>